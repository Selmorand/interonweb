name: Deploy to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Create target directory if it doesn't exist
            if (-not (Test-Path C:\inetpub\wwwroot\InteronWeb)) {
              New-Item -ItemType Directory -Path C:\inetpub\wwwroot\InteronWeb
            }

            cd /d C:\Users\$env:USERNAME\AppData\Local\InteronWebDeploy

            # Pull latest code
            if (-not (Test-Path .git)) {
              git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git .
            }
            git fetch origin main
            git reset --hard origin/main
            git clean -fdx

            # Build and publish to clean location
            cd cms
            dotnet restore
            dotnet publish -c Release -o C:\inetpub\wwwroot\InteronWeb\publish --no-self-contained

            # Verify IIS configuration
            Import-Module WebAdministration
            $site = Get-Website -Name "Default Web Site" -ErrorAction SilentlyContinue
            if ($site) {
              if ($site.PhysicalPath -ne "C:\inetpub\wwwroot\InteronWeb\publish") {
                Write-Host "Updating IIS site path to C:\inetpub\wwwroot\InteronWeb\publish"
                Set-ItemProperty "IIS:\Sites\Default Web Site" -Name physicalPath -Value "C:\inetpub\wwwroot\InteronWeb\publish"
              }
              Write-Host "IIS configuration verified: Default Web Site -> C:\inetpub\wwwroot\InteronWeb\publish"
            }

            # Restart app pool
            Restart-WebAppPool -Name 'DefaultAppPool'

            # Wait for app to start and verify it's running
            Start-Sleep -Seconds 5
            $response = Invoke-WebRequest -Uri "https://interon.co.za/" -UseBasicParsing -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) {
              Write-Host "Deployment successful! Site is responding with HTTP 200"
            } else {
              Write-Host "WARNING: Site may not be responding correctly"
            }

@page
@model InteronBlog.Pages.Admin.IndexModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Dashboard";
}

<div class="admin-dashboard">
    <!-- Quick Actions -->
    <div class="admin-section mb-4">
        <div class="admin-section-header">
            <h2>Quick Actions</h2>
        </div>
        <div class="grid grid-3" style="gap: 1rem;">
            <a href="/admin/knowledgegraphbuilder" class="btn btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <span>&#10133;</span> New Knowledge Graph Report
            </a>
            <a href="/admin/posts/create" class="btn btn-secondary" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <span>&#10133;</span> New Insight Post
            </a>
            <a href="/" class="btn btn-secondary" target="_blank" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <span>&#127968;</span> View Website
            </a>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="dashboard-grid mb-4">
        <div class="stat-card">
            <div class="stat-value">@Model.Stats.TotalPosts</div>
            <div class="stat-label">Total Posts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-published">@Model.Stats.PublishedPosts</div>
            <div class="stat-label">Published</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-draft">@Model.Stats.DraftPosts</div>
            <div class="stat-label">Drafts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">@Model.Stats.TotalViews</div>
            <div class="stat-label">Total Views</div>
        </div>
    </div>

    <!-- Knowledge Graph Reports Section -->
    <div class="admin-section mb-4">
        <div class="admin-section-header">
            <h2>Knowledge Graph Reports</h2>
            <a href="/admin/knowledgegraphbuilder" class="btn btn-primary">Create New Report</a>
        </div>

        <div id="reports-container">
            <div class="loading" id="reports-loading">
                <div class="spinner"></div>
                <p>Loading reports...</p>
            </div>
            <div id="reports-list" class="hidden"></div>
            <div id="reports-error" class="hidden alert alert-error"></div>
            <div id="reports-empty" class="hidden empty-state">
                <p>No reports yet. Create your first knowledge graph report!</p>
                <a href="/admin/knowledgegraphbuilder" class="btn btn-primary">Create First Report</a>
            </div>
        </div>
    </div>

    <!-- Recent Posts -->
    <div class="admin-section">
        <div class="admin-section-header">
            <h2>Recent Posts</h2>
            <a href="/admin/posts" class="btn btn-secondary">View All Posts</a>
        </div>

        @if (Model.RecentPosts.Any())
        {
            <div class="posts-table">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var post in Model.RecentPosts)
                        {
                            <tr>
                                <td><strong>@post.Title</strong></td>
                                <td>
                                    @if (!string.IsNullOrEmpty(post.Category))
                                    {
                                        <span class="tag">@post.Category</span>
                                    }
                                </td>
                                <td>
                                    @if (post.IsPublished)
                                    {
                                        <span class="status status-published">Published</span>
                                    }
                                    else
                                    {
                                        <span class="status status-draft">Draft</span>
                                    }
                                </td>
                                <td>@(post.PublishedAt?.ToString("MMM d, yyyy") ?? post.CreatedAt.ToString("MMM d, yyyy"))</td>
                                <td class="actions">
                                    <a href="/admin/posts/edit/@post.Id" class="btn-icon" title="Edit">&#9998;</a>
                                    @if (post.IsPublished)
                                    {
                                        <a href="/insights/@(post.Slug)/" class="btn-icon" target="_blank" title="View">&#128065;</a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>No posts yet. Create your first post to get started!</p>
                <a href="/admin/posts/create" class="btn btn-primary">Create First Post</a>
            </div>
        }
    </div>
</div>

<style>
.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.report-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    padding: 1.5rem;
    transition: all var(--transition-base);
}

.report-card:hover {
    border-color: var(--accent-blue);
    box-shadow: var(--shadow-glow-blue);
}

.report-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.report-card-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.report-card-domain {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.report-card-stats {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    padding-top: 1rem;
    border-top: 1px solid var(--glass-border);
}

.report-stat {
    display: flex;
    flex-direction: column;
}

.report-stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--accent-blue);
}

.report-stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.report-card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}
</style>

@section Scripts {
<script>
const API_URL = 'https://web-production-9ed67.up.railway.app';

async function loadReports() {
    const loading = document.getElementById('reports-loading');
    const list = document.getElementById('reports-list');
    const error = document.getElementById('reports-error');
    const empty = document.getElementById('reports-empty');

    try {
        const response = await fetch(`${API_URL}/api/report/`);

        if (!response.ok) {
            throw new Error('Failed to load reports');
        }

        const data = await response.json();

        loading.classList.add('hidden');

        if (data.total === 0) {
            empty.classList.remove('hidden');
            return;
        }

        // Display reports
        const reportsHtml = data.reports.map(report => `
            <div class="report-card">
                <div class="report-card-header">
                    <div>
                        <div class="report-card-title">${report.title || report.domain}</div>
                        <div class="report-card-domain">${report.url}</div>
                    </div>
                    <span class="status status-${report.status.toLowerCase()}">${report.status}</span>
                </div>
                <div class="report-card-stats">
                    <div class="report-stat">
                        <span class="report-stat-value">${report.pageCount}</span>
                        <span class="report-stat-label">Pages</span>
                    </div>
                    <div class="report-stat">
                        <span class="report-stat-value">${report.entityCount}</span>
                        <span class="report-stat-label">Entities</span>
                    </div>
                </div>
                <div class="report-card-actions">
                    <a href="${API_URL}/api/report/${report.siteId}" target="_blank" class="btn btn-primary btn-sm">View Report</a>
                    <a href="${API_URL}/api/report/${report.siteId}/export/pdf" class="btn btn-secondary btn-sm">Export PDF</a>
                </div>
            </div>
        `).join('');

        list.innerHTML = `<div class="reports-grid">${reportsHtml}</div>`;
        list.classList.remove('hidden');

    } catch (err) {
        console.error('Load reports error:', err);
        loading.classList.add('hidden');
        error.textContent = 'Failed to load reports. Please try again later.';
        error.classList.remove('hidden');
    }
}

// Load reports on page load
document.addEventListener('DOMContentLoaded', loadReports);
</script>
}

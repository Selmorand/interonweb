@page "{id}"
@model InteronBlog.Pages.Admin.Posts.EditModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Edit Post";
}

@section Head {
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <style>
        .ql-editor { min-height: 300px; background: var(--bg-surface); color: var(--text-primary); }
        .ql-toolbar { background: var(--bg-elevated); border-color: var(--glass-border) !important; }
        .ql-container { border-color: var(--glass-border) !important; font-size: 1rem; }
        .ql-toolbar button, .ql-toolbar .ql-picker { color: var(--text-secondary); }
        .ql-toolbar button:hover, .ql-toolbar .ql-picker:hover { color: var(--text-primary); }
        .ql-toolbar .ql-stroke { stroke: var(--text-secondary); }
        .ql-toolbar .ql-fill { fill: var(--text-secondary); }
        .ql-toolbar button:hover .ql-stroke { stroke: var(--text-primary); }
        .ql-toolbar button:hover .ql-fill { fill: var(--text-primary); }
        .ql-toolbar .ql-picker-options { background: var(--bg-elevated); }
    </style>
}

@if (Model.Post == null)
{
    <div class="alert alert-error">Post not found.</div>
    <a href="/admin/posts" class="btn btn-secondary">Back to Posts</a>
}
else
{
    <form method="post" enctype="multipart/form-data" class="post-form">
        <input type="hidden" name="Post.Id" value="@Model.Post.Id" />
        <input type="hidden" name="Post.CreatedAt" value="@Model.Post.CreatedAt.ToString("o")" />
        <input type="hidden" name="Post.ViewCount" value="@Model.Post.ViewCount" />

        <div class="form-grid">
            <div class="form-main">
                <div class="form-group">
                    <label for="Title" class="form-label">Title *</label>
                    <input type="text" id="Title" name="Post.Title" value="@Model.Post.Title"
                           class="form-input" required placeholder="Enter post title">
                    <span asp-validation-for="Post.Title" class="validation-error"></span>
                </div>

                <div class="form-group">
                    <label for="Slug" class="form-label">Slug (URL)</label>
                    <input type="text" id="Slug" name="Post.Slug" value="@Model.Post.Slug"
                           class="form-input" placeholder="auto-generated-from-title">
                    <small class="form-hint">
                        Current URL: <a href="/insights/@(Model.Post.Slug)/" target="_blank">/insights/@(Model.Post.Slug)/</a>
                    </small>
                </div>

                <div class="form-group">
                    <label for="Excerpt" class="form-label">Excerpt</label>
                    <textarea id="Excerpt" name="Post.Excerpt" class="form-textarea" rows="3"
                              placeholder="Brief summary for listings (optional)">@Model.Post.Excerpt</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Content *</label>
                    <div id="editor">@Html.Raw(Model.Post.Content)</div>
                    <input type="hidden" id="Content" name="Post.Content" value="@Model.Post.Content">
                </div>

                <div class="seo-section card">
                    <h3>SEO Settings</h3>
                    <div class="form-group">
                        <label for="MetaTitle" class="form-label">Meta Title</label>
                        <input type="text" id="MetaTitle" name="Post.MetaTitle" value="@Model.Post.MetaTitle"
                               class="form-input" placeholder="Leave empty to use post title">
                        <small class="form-hint">Recommended: 50-60 characters</small>
                    </div>

                    <div class="form-group">
                        <label for="MetaDescription" class="form-label">Meta Description</label>
                        <textarea id="MetaDescription" name="Post.MetaDescription" class="form-textarea" rows="2"
                                  placeholder="Leave empty to use excerpt">@Model.Post.MetaDescription</textarea>
                        <small class="form-hint">Recommended: 150-160 characters</small>
                    </div>
                </div>
            </div>

            <div class="form-sidebar">
                <div class="sidebar-card">
                    <h3>Publish</h3>
                    <div class="post-meta">
                        <p><strong>Created:</strong> @Model.Post.CreatedAt.ToString("MMM d, yyyy h:mm tt")</p>
                        @if (Model.Post.UpdatedAt.HasValue)
                        {
                            <p><strong>Updated:</strong> @Model.Post.UpdatedAt.Value.ToString("MMM d, yyyy h:mm tt")</p>
                        }
                        @if (Model.Post.PublishedAt.HasValue)
                        {
                            <p><strong>Published:</strong> @Model.Post.PublishedAt.Value.ToString("MMM d, yyyy h:mm tt")</p>
                        }
                        <p><strong>Views:</strong> @Model.Post.ViewCount</p>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="Post.IsPublished" value="true" @(Model.Post.IsPublished ? "checked" : "")>
                            Published
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="Post.IsFeatured" value="true" @(Model.Post.IsFeatured ? "checked" : "")>
                            Featured post
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Update Post</button>
                        <a href="/admin/posts" class="btn btn-secondary">Cancel</a>
                    </div>
                    @if (Model.Post.IsPublished)
                    {
                        <a href="/insights/@(Model.Post.Slug)/" class="btn btn-secondary" target="_blank" style="margin-top: 0.5rem; width: 100%; text-align: center;">
                            View Post
                        </a>
                    }
                </div>

                <div class="sidebar-card">
                    <h3>Category</h3>
                    <div class="form-group">
                        <select name="Post.Category" class="form-select">
                            <option value="">Select category</option>
                            @foreach (var cat in Model.Categories)
                            {
                                <option value="@cat.Slug" selected="@(Model.Post.Category == cat.Slug)">@cat.Name</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3>Tags</h3>
                    <div class="form-group">
                        <input type="text" id="TagsInput" name="TagsString" value="@Model.TagsString"
                               class="form-input" placeholder="tag1, tag2, tag3">
                        <small class="form-hint">Separate tags with commas</small>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3>Featured Image</h3>
                    <div class="form-group">
                        <input type="file" id="FeaturedImageFile" name="FeaturedImageFile"
                               class="form-input" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label for="FeaturedImageUrl" class="form-label">Or enter URL</label>
                        <input type="text" id="FeaturedImageUrl" name="Post.FeaturedImage"
                               value="@Model.Post.FeaturedImage" class="form-input"
                               placeholder="/uploads/images/...">
                    </div>
                    <div id="image-preview" class="image-preview">
                        @if (!string.IsNullOrEmpty(Model.Post.FeaturedImage))
                        {
                            <img src="@Model.Post.FeaturedImage" alt="Preview">
                        }
                    </div>
                    <div class="form-group">
                        <label for="FeaturedImageAlt" class="form-label">Alt Text</label>
                        <input type="text" id="FeaturedImageAlt" name="Post.FeaturedImageAlt"
                               value="@Model.Post.FeaturedImageAlt" class="form-input"
                               placeholder="Describe the image">
                    </div>
                </div>

                <div class="sidebar-card sidebar-card-danger">
                    <h3>Danger Zone</h3>
                    <form method="post" asp-page-handler="Delete"
                          onsubmit="return confirm('Are you sure you want to delete this post? This cannot be undone.')">
                        <button type="submit" class="btn btn-danger">Delete Post</button>
                    </form>
                </div>
            </div>
        </div>
    </form>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-error">@Model.ErrorMessage</div>
}

@section Scripts {
    <script>
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['blockquote', 'code-block'],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        // Sync editor content to hidden input on form submit
        document.querySelector('form.post-form').addEventListener('submit', function() {
            document.getElementById('Content').value = quill.root.innerHTML;
        });

        // Image preview
        document.getElementById('FeaturedImageFile').addEventListener('change', function(e) {
            var preview = document.getElementById('image-preview');
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
}
